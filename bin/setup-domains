#!/bin/bash

# Path to the hosts file
HOSTS_FILE="/etc/hosts"

YELLOW_BEGIN="\e[33m"
YELLOW_END="\e[0m"
GREEN_BEGIN="\e[32m"
GREEN_END="\e[0m"

# Function to remove existing hosts entries
remove_existing_hosts_entries() {
    printf $"${GREEN_BEGIN}"
    echo -e "\nRemoving existing entries for MUSCLE..."
    printf "${GREEN_END}"
    # Check if we are on macOS and adjust the sed command accordingly
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sudo sed -i '' '/# MUSCLE/,/# END MUSCLE/d' "$HOSTS_FILE"
    else
        sudo sed -i '/# MUSCLE/,/# END MUSCLE/d' "$HOSTS_FILE"
    fi
}

# Function to add hosts entries
add_hosts_entries() {
    printf $"${GREEN_BEGIN}"
    echo -e "\nAdding the following entries to your hosts file:"
    printf "${GREEN_END}"
    for entry in "${HOST_ENTRIES[@]}"; do
        echo "$entry"
    done
    for entry in "${HOST_ENTRIES[@]}"; do
        echo "$entry" | sudo tee -a "$HOSTS_FILE" > /dev/null
    done
}

# Replace AML_ALLOWED_HOSTS and REACT_APP_API_ROOT values in .env file
replace_env_variables() {
    # Get the backend domain without port number (if any) for AML_ALLOWED_HOSTS
    backend_domain_without_port="${backend_domain%:*}"

    printf $"${GREEN_BEGIN}"
    echo -e "\nReplacing CLIENT_DOMAIN, SERVER_DOMAIN, AML_ALLOWED_HOSTS and REACT_APP_API_ROOT values in .env file..."
    printf "${GREEN_END}"

    # Add CLIENT_DOMAIN if it doesn't exist and then replace the value
    if ! grep -q "CLIENT_DOMAIN" .env; then
        echo "CLIENT_DOMAIN=" >> .env
    fi
    sed -i '' "s/CLIENT_DOMAIN=.*/CLIENT_DOMAIN=$main_domain/g" .env

    # Add SERVER_DOMAIN if it doesn't exist and then replace the value
    if ! grep -q "SERVER_DOMAIN" .env; then
        echo "SERVER_DOMAIN=" >> .env
    fi
    sed -i '' "s/SERVER_DOMAIN=.*/SERVER_DOMAIN=$backend_domain/g" .env

    # Add AML_ALLOWED_HOSTS if it doesn't exist and then replace the value
    if ! grep -q "AML_ALLOWED_HOSTS" .env; then
        echo "AML_ALLOWED_HOSTS=" >> .env
    fi
    # include "$SERVER_DOMAIN" in AML_ALLOWED_HOSTS
    sed -i '' "s/AML_ALLOWED_HOSTS=.*/AML_ALLOWED_HOSTS=\$SERVER_DOMAIN,$main_domain,$backend_domain_without_port,localhost/g" .env

    # Add REACT_APP_API_ROOT if it doesn't exist and then replace the value
    if ! grep -q "REACT_APP_API_ROOT" .env; then
        echo "REACT_APP_API_ROOT=" >> .env
    fi
    sed -i '' "s/REACT_APP_API_ROOT=.*/REACT_APP_API_ROOT=http:\/\/$backend_domain/g" .env
}

# Function to get domain selection
get_domain_selection() {
    local PS3="Please choose a domain for $1: "
    local options=("$2" "$3" "other (type a custom domain yourself)")
    local domain

    select opt in "${options[@]}"; do
        case $REPLY in
            1) domain=$2; break ;;
            2) domain=$3; break ;;
            *) domain=$REPLY; break ;;
        esac
    done

    echo "$domain"
}

# Main domain selection
printf $"${YELLOW_BEGIN}"
echo -e "\n# Define main site domain (the user interface)"
printf "${YELLOW_END}"
main_domain=$(get_domain_selection "main site" "muscle.local" "localhost:3000")

printf "\nYou have chosen ${GREEN_BEGIN}$main_domain${GREEN_END} as your main site domain.\n"

# Backend domain selection
printf $"${YELLOW_BEGIN}"
echo -e "\n# Define backend domain (the admin interface)"
printf "${YELLOW_END}"
backend_domain=$(get_domain_selection "backend" "backend.muscle.local" "localhost:8000")

printf "\nYou have chosen ${GREEN_BEGIN}$backend_domain${GREEN_END} as your backend domain.\n"

# Define hosts entries
HOST_ENTRIES=(
    "# MUSCLE"
    "127.0.0.1 $main_domain"
    "127.0.0.1 $backend_domain"
    "# END MUSCLE"
)


# Backup the original hosts file
echo -e "\nBacking up your hosts file to ${HOSTS_FILE}.bak..."
printf $"${YELLOW_BEGIN}"
echo -e "You may be asked for your password."
printf "${YELLOW_END}"
sudo cp "$HOSTS_FILE" "${HOSTS_FILE}.bak"

# Remove existing MUSCLE entries
remove_existing_hosts_entries

# Add new MUSCLE entries
add_hosts_entries

# Replace AML_ALLOWED_HOSTS and REACT_APP_API_ROOT values in .env
replace_env_variables

printf "\nDone! You can now access the MUSCLE platform at the following addresses:\n1) User interface:      ${GREEN_BEGIN}http://$main_domain${GREEN_END}\n2) Admin interface:     ${GREEN_BEGIN}http://$backend_domain/admin${GREEN_END}.\n"
printf "\nDon't forget to run ${GREEN_BEGIN}docker-compose up${GREEN_END} to (re-)start the platform.\n"