# Generated by Django 4.2.16 on 2024-10-28 16:06

from django.db import migrations
from django.conf import settings
from django.utils import translation


def add_social_media_config(apps, schema_editor):
    """add information from rules files to database"""
    Block = apps.get_model("experiment", "Block")
    ExperimentTranslatedContent = apps.get_model(
        "experiment", "ExperimentTranslatedContent"
    )
    SocialMediaConfig = apps.get_model("experiment", "SocialMediaConfig")
    blocks = Block.objects.all()
    for block in blocks:
        if block.rules in [
            "HOOKED",
            "EUROVISION_2020",
            "KUIPER_2020",
            "HUANG_2022",
            "MUSICAL_PREFERENCES",
            "MATCHING_PAIRS",
        ]:
            channels = ["facebook", "twitter"]
            if block.rules == "MATCHING_PAIRS":
                channels.append("clipboard")
            elif block.rules == "MUSICAL_PREFERENCES":
                channels = ["weibo", "share"]
            if not SocialMediaConfig.objects.filter(
                experiment=block.phase.experiment
            ).exists():
                SocialMediaConfig.objects.create(
                    experiment=block.phase.experiment,
                    tags=["amsterdammusiclab", "citizenscience"],
                    url=f"{settings.RELOAD_PARTICIPANT_TARGET}/{block.slug}",
                    channels=channels,
                )
            if not ExperimentTranslatedContent.objects.filter(
                experiment=block.phase.experiment
            ).exists():
                ExperimentTranslatedContent.objects.create(
                    experiment=block.phase.experiment,
                    language="en",
                    name=block.phase.experiment.slug,
                )

class Migration(migrations.Migration):

    dependencies = [
        ("experiment", "0058_remove_socialmediaconfig_content_and_more"),
    ]

    operations = [
        migrations.RunPython(add_social_media_config, migrations.RunPython.noop)
    ]
