# Generated by Django 4.2.17 on 2025-01-07 09:24

from django.db import migrations, models


class Migration(migrations.Migration):

    def forwards_func(apps, schema_editor):
        Experiment = apps.get_model('experiment', 'Experiment')
        ExperimentTranslatedContent  = apps.get_model('experiment', 'ExperimentTranslatedContent')
        FooterConfig = apps.get_model('theme', 'FooterConfig')
        for experiment in Experiment.objects.all():
            if experiment.theme_config:
                this_footer = FooterConfig.objects.get(theme=experiment.config)
            if this_footer is not None:
                content, created = ExperimentTranslatedContent.objects.get_or_create(
                    experiment=experiment,
                    language="en",
                )
                content.privacy = this_footer.privacy
                content.disclaimer = this_footer.disclaimer
                content.save()
                if created:
                    experiment.translated_content.add(content)

    def reverse_func(apps, schema_editor):
        Experiment = apps.get_model('experiment', 'Experiment')
        ExperimentTranslatedContent  = apps.get_model('experiment', 'ExperimentTranslatedContent')
        FooterConfig = apps.get_model('theme', 'FooterConfig')
        ThemeConfig = apps.get_model('theme', 'ThemeConfig')
        for experiment in Experiment.objects.all():
            content = ExperimentTranslatedContent.objects.filter(language="en")
            if content.count() == 1:
                if content.privacy != "" and content.disclaimer != "":
                    if not experiment.theme_config:
                        theme = ThemeConfig.objects.create(
                            name=f"{experiment.slug}-{experiment.id}",
                        )
                    else:
                        theme = experiment.theme_config
                    footer = FooterConfig.objects.get_or_create(theme=theme)
                    footer.disclaimer = content.disclaimer
                    footer.privacy = content.privacy
                    footer.save()

    dependencies = [
        ('experiment', '0062_rename_slug_temp_to_slug'),
    ]

    operations = [
        migrations.AddField(
            model_name='experimenttranslatedcontent',
            name='disclaimer',
            field=models.TextField(blank=True, default=''),
        ),
        migrations.AddField(
            model_name='experimenttranslatedcontent',
            name='privacy',
            field=models.TextField(blank=True, default=''),
        ),
        migrations.RunPython(forwards_func, reverse_func),
    ]
