# Generated by Django 4.2.14 on 2024-08-07 14:30

from django.db import migrations


def migrate_block_content(apps, schema_editor):
    Block = apps.get_model("experiment", "Block")
    BlockTranslatedContent = apps.get_model("experiment", "BlockTranslatedContent")
    Phase = apps.get_model("experiment", "Phase")
    Experiment = apps.get_model("experiment", "Experiment")
    ExperimentTranslatedContent = apps.get_model("experiment", "ExperimentTranslatedContent")

    for block in Block.objects.all():
        language = block.language if block.language else "en"

        block_translated_content = BlockTranslatedContent.objects.create(
            language=language,
            name=block.name,
            description=block.description,
        )
        block_translated_content.block.add(block)

        if block.phase:
            continue

        # if block is not associated with a phase and experiment,
        # create a new experiment and phase
        experiment = Experiment.objects.create(
            slug=block.slug,
        )
        ExperimentTranslatedContent.objects.create(
            experiment=experiment,
            index=0,
            language=language,
            name=block.name,
            description=block.description,
            consent=block.consent if block.consent else "",
        )
        Phase.objects.create(
            experiment=experiment,
            index=0,
        )


def reverse_migrate_block_content(apps, schema_editor):
    Block = apps.get_model("experiment", "Block")
    BlockTranslatedContent = apps.get_model("experiment", "BlockTranslatedContent")
    Experiment = apps.get_model("experiment", "Experiment")
    ExperimentTranslatedContent = apps.get_model("experiment", "ExperimentTranslatedContent")

    for block in Block.objects.all():
        block_fallback_content = BlockTranslatedContent.objects.filter(block=block).first()

        phase = block.phase
        experiment = Experiment.objects.filter(phases=phase).first()
        experiment_fallback_content = (
            ExperimentTranslatedContent.objects.filter(experiment=experiment).order_by("index").first()
        )

        if experiment_fallback_content:
            language = experiment_fallback_content.language
            possible_block_fallback_content = BlockTranslatedContent.objects.filter(
                language=language, block=block
            ).first()
            if possible_block_fallback_content:
                block_fallback_content = possible_block_fallback_content

        if not block_fallback_content:
            continue

        block.name = block_fallback_content.name if block_fallback_content.name else block.slug
        block.description = block_fallback_content.description if block_fallback_content.description else ""
        block.consent = (
            experiment_fallback_content.consent
            if experiment_fallback_content and experiment_fallback_content.consent
            else ""
        )
        block.save()

    BlockTranslatedContent.objects.all().delete()


class Migration(migrations.Migration):
    dependencies = [
        ("experiment", "0053_alter_block_options_rename_series_phase_experiments_and_more"),
    ]

    operations = [
        migrations.RunPython(migrate_block_content, reverse_migrate_block_content),
    ]
